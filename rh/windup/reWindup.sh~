#!/bin/bash

set -x
set -e

MIGR_DIR="~/work/mig"

if [ "$1" == "skip" ] ; then exit; fi

TMPDIR=/tmp/windup

## Rebuild Windup Core
if [[ "$1" != "" && "$1" != "no" ]] ; then
  cd $MIGR_DIR/Windup
  mvn clean install -DskipTests
fi

## Rebuild Windup Rulesets
if [ "$2" != "" ] ; then
  cd $MIGR_DIR/windup-rulesets
  mvn clean install -DskipTests
fi


## Rebuild Windup and unzip it.
cd $MIGR_DIR/windup-distribution/


## Rebuild Windup Distribution
if [ "$1" == "stash" ] ; then
  mvn clean
  git stash
  git checkout master
  git pull
  mvn install -DskipTests
  git checkout -
  #git stash pop || true
else
  mvn clean install -DskipTests
fi

rm -rf $TMPDIR/
mkdir -p $TMPDIR/
unzip -q target/windup-distribution-*-offline.zip -d $TMPDIR/
mv /tmp/windup/windup-distribution-* $TMPDIR/unzipped
#$TMPDIR/home/bin/windup -e "addon-remove --addons org.jboss.windup.quickstarts:windup-weblogic-javaee-servlet,2.0.0.Beta3"
#$TMPDIR/home/bin/windup -e "cd ../WindupQuickstarts/weblogic-javaee-servlet; addon-install; cd ../../Windup"
#$TMPDIR/home/bin/windup
cd -


#mvn clean install -DskipTests -f ../Windup/pom.xml;
#rm -rf windup-distribution-*
#unzip ../Windup/dist/target/windup-distribution-*.zip
#windup-distribution-*/bin/windup
